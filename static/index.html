<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>deepelak</title>
    <link rel="stylesheet" href="/static/assets/style/paper.css" />
    <link rel="stylesheet" href="/static/assets/style/style.css" />
  </head>
  <body class="paper">
    <div class="row">
      <div class="card md-4 col margin-right margin-bottom">
        <div class="card-body">
          <h4 class="card-title">DeePelak</h4>
          <h5 class="card-subtitle">interactive ALPR playground</h5>
          <p class="card-text">
            Explore ALPR models in action â€” upload images, tweak settings, and
            compare automatic license plate recognition results instantly.
          </p>
        </div>
      </div>
      <div class="card md-4 col">
        <div class="card-body">
          <div class="row">
            <input id="file" type="file" hidden />
            <input
              id="buttonid"
              type="button"
              class="btn-block btn-secondary-outline"
              value="Upload Car Image"
              onclick="handleFileUpload()"
            />
          </div>
          <div class="separator">
            <h5 class="card-subtitle">Or choose from images below</h5>
          </div>
          <img
            class="thumbnail"
            src="/static/assets/images/samples/car1.jpg"
            onclick="handleThumbnailClick(this)"
          />
        </div>
      </div>
    </div>
    <div class="row">
      <div class="card md-4 col margin-right margin-bottom">
        <img id="car" src="/static/assets/images/samples/car1.jpg" />
      </div>
      <div class="card md-4 col" style="display: none">
        <div class="row flex-spaces" id="plate-container"></div>
      </div>
    </div>
  </body>
  <script>
    const fileInput = document.getElementById("file");
    const plateContainer = document.getElementById("plate-container");
    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        uploadImage(file);
      }
    });
    function handleFileUpload() {
      fileInput.click();
    }
    function handleThumbnailClick(img) {
      fetch(img.src)
        .then((res) => res.blob())
        .then((blob) => {
          const file = new File([blob], img.src.split("/").pop(), {
            type: blob.type,
          });
          uploadImage(file);
        });
    }
    function addPlate(imgUrl) {
      plateContainer.parentElement.style.display = "block";
      const colDiv = document.createElement("div");
      colDiv.className = "col md-6";
      const img = document.createElement("img");
      img.src = imgUrl;
      colDiv.appendChild(img);
      plateContainer.appendChild(colDiv);
    }
    function b64toBlob(b64) {
      const byteCharacters = atob(b64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: "image/png" });
    }
    async function uploadImage(selectedFile) {
      const detection_payload = new FormData();
      detection_payload.append("file", selectedFile);

      try {
        const detection_response = await fetch("/detect", {
          method: "POST",
          body: detection_payload,
        });

        if (!detection_response.ok) {
          throw new Error(`HTTP error! status: ${detection_response.status}`);
        }

        let should_send_request = true;

        const detection_data = await detection_response.json();
        const carBlob = b64toBlob(detection_data.image);
        const carUrl = URL.createObjectURL(carBlob);
        document.getElementById("car").src = carUrl;

        while (should_send_request) {
          const recognition_response = await fetch(
            `/recognize?rid=${detection_data.rid}`
          );

          const recognition_data = await recognition_response.json();
          const plateBlob = b64toBlob(recognition_data.image);
          const plateUrl = URL.createObjectURL(plateBlob);
          addPlate(plateUrl);
          should_send_request = recognition_data.more;
        }
      } catch (error) {
        console.error("Error: ", error);
      }
    }
  </script>
</html>
