<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>deepelak</title>
    <link rel="stylesheet" href="/static/assets/style/paper.css" />
    <link rel="stylesheet" href="/static/assets/style/style.css" />
    <link rel="icon" href="/static/assets/icons/favicon.svg" />
  </head>
  <body class="paper">
    <div class="row">
      <div class="card md-8 col margin-right margin-bottom">
        <div class="card-body">
          <h4 class="card-title">DeePelak</h4>
          <h5 class="card-subtitle">interactive ALPR playground</h5>
          <p class="card-text">
            Explore ALPR models in action â€” upload images, tweak settings, and
            compare automatic license plate recognition results instantly.
            (coming soon)
          </p>
          <a
            href="https://colab.research.google.com/drive/1AQWI11t2PuihdivXBwxGZpU8Wf_9wETD"
            target="_blank"
            >colab</a
          >
          <a target="_blank" href="https://github.com/HesamSoleymani/deepelak"
            >github</a
          >
        </div>
      </div>
    </div>
    <div class="row">
      <div class="card md-4 col margin-right margin-bottom">
        <div class="card-body">
          <h4 class="card-title">Model Selection</h4>
          <h5 class="card-subtitle">Plate Detector Model</h5>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label>current selected model</label>
              <div
                id="model-string"
                class="input-block padding-small"
                style="
                  background: #f5f5f5;
                  padding: 8px 12px;
                  border-radius: 4px;
                "
              >
                yolov8_s_none_0.001_e1
              </div>
            </div>
          </div>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label for="detector-model-name">Model Name</label>
              <select id="detector-model-name" class="input-block">
                <option value="yolov8" selected>YOLOv8</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-model-size">Model Size</label>
              <select id="detector-model-size" class="input-block">
                <option value="xs">XS</option>
                <option value="s">S</option>
                <option value="m">M</option>
                <option value="l">L</option>
                <option value="xl">XL</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-pretrained">Pretrained On</label>
              <select id="detector-pretrained" class="input-block">
                <option value="none" selected>None</option>
                <option value="coco">COCO</option>
                <option value="pascalvoc">Pascal VOC</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-lr">Learning Rate</label>
              <select id="detector-lr" class="input-block">
                <option value="0.0001">0.0001</option>
                <option value="0.0005">0.0005</option>
                <option value="0.001" selected>0.001</option>
                <option value="0.005">0.005</option>
                <option value="0.01">0.01</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-epochs">Epochs</label>
              <select id="detector-epochs" class="input-block">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
          <script>
            function updateModelString() {
              const name = document.getElementById("detector-model-name").value;
              const size = document.getElementById("detector-model-size").value;
              const pretrained = document.getElementById(
                "detector-pretrained"
              ).value;
              const lr = document.getElementById("detector-lr").value;
              let epochs = document.getElementById("detector-epochs").value;
              epochs = epochs.padStart(4, "0");
              const modelStr = `${name}_${size}_${pretrained}_${lr}_e${epochs}`;
              document.getElementById("model-string").textContent = modelStr;
            }
            [
              "detector-model-name",
              "detector-model-size",
              "detector-pretrained",
              "detector-lr",
              "detector-epochs",
            ].forEach((id) => {
              document
                .getElementById(id)
                .addEventListener("change", updateModelString);
            });
            updateModelString();
          </script>
          <h5 class="card-subtitle" style="margin-top: 16px">
            Plate Recognizer Model
          </h5>
        </div>
      </div>
      <div class="card md-4 col">
        <div id="file-upload" class="card-body">
          <div class="row">
            <input id="file" type="file" hidden />
            <input
              id="buttonid"
              type="button"
              class="btn-block btn-secondary-outline"
              value="Upload Car Image"
              onclick="handleFileUpload()"
            />
          </div>
          <div class="separator">
            <h5 class="card-subtitle">Or choose from images below</h5>
          </div>
          <div class="row">
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car1.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car2.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car3.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car4.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car5.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car6.jpg"
              onclick="handleThumbnailClick(this)"
            />
          </div>
        </div>
        <div id="file-details" class="card-body" style="display: none">
          <div class="row flex-bottom" style="flex-wrap: nowrap">
            <img
              id="uploaded-file"
              class="thumbnail margin-right"
              src="/static/assets/images/samples/car1.jpg"
            />
            <div style="overflow: hidden">
              <p id="filename" class="cut-text"></p>
              <p id="filesize" style="margin-bottom: 0 !important"></p>
            </div>
          </div>
          <div class="progress margin-bottom">
            <div id="upload-progress" class="bar striped secondary w-40"></div>
          </div>
          <div
            id="restart"
            class="text-center margin-top"
            style="cursor: pointer"
          >
            <a>Upload another image</a>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div
        class="card md-4 col margin-right margin-bottom"
        style="display: none"
      >
        <div>
          <p style="margin: 0">step 1:</p>
          <h3 style="margin: 0">License Plate Detection</h3>
          <div class="model">
            <span>model:</span>
            <span class="badge secondary">YOLO V8</span>
            <div
              popover-bottom="epochs = 3 | learning rate = 0.001 | global clipnorm = 10"
            >
              <img class="no-border info" src="/static/assets/icons/info.svg" />
            </div>
          </div>
        </div>
        <div id="car"></div>
      </div>
      <div class="card md-4 col" style="display: none">
        <div>
          <p style="margin: 0">step 2:</p>
          <h3 style="margin: 0">License Plate Recognition</h3>
          <div class="model">
            <span>model:</span>
            <span class="badge secondary">YOLO V8</span>
            <div
              popover-bottom="epochs = 3 | learning rate = 0.001 | global clipnorm = 10"
            >
              <img class="no-border info" src="/static/assets/icons/info.svg" />
            </div>
          </div>
        </div>
        <div class="row flex-spaces" id="plate-container"></div>
      </div>
    </div>
  </body>
  <script>
    let selected_detector_model = "plate_detector";
    let selected_recognizer_model = "plate_recognizer";
    const fileInput = document.getElementById("file");
    const plateContainer = document.getElementById("plate-container");
    const uploadProgress = document.getElementById("upload-progress");
    const car = document.getElementById("car");
    const loading = document.createElement("div");
    loading.appendChild(document.createElement("img"));
    loading.appendChild(document.createElement("p"));
    loading.childNodes[0].className = "loading no-border";
    loading.childNodes[0].src = "/static/assets/icons/processing.svg";
    loading.childNodes[1].innerHTML = "processing...";
    loading.childNodes[1].className = "text-center";
    document
      .getElementById("restart")
      .addEventListener("click", function (event) {
        document.getElementById("file-upload").style.display = "block";
        document.getElementById("file-details").style.display = "none";
      });
    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file.size > 10 * 1024 * 1024) {
        alert("Filesize is too large! Max filesize is 10MB.");
        return;
      }
      document.getElementById("uploaded-file").src = URL.createObjectURL(file);
      if (file) {
        uploadImage(file);
      }
      fileInput.value = "";
    });
    function handleFileUpload() {
      fileInput.click();
    }
    function handleThumbnailClick(img) {
      document.getElementById("uploaded-file").src = img.src;
      fetch(img.src)
        .then((res) => res.blob())
        .then((blob) => {
          const file = new File([blob], img.src.split("/").pop(), {
            type: blob.type,
          });
          uploadImage(file);
        });
    }
    function selectModel(div, type) {
      div.parentElement.childNodes.forEach((element) => {
        if (element.style?.background) {
          element.style.background = "transparent";
        }
      });
      div.style.background = "#69a1d433";
      if (type == "detector") selected_detector_model = div.dataset.model;
      else selected_recognizer_model = div.dataset.model;
    }
    function addPlate(imgUrl, text) {
      const colDiv = document.createElement("div");
      colDiv.className = "col md-6";
      const img = document.createElement("img");
      img.src = imgUrl;

      const match = text.match(/^(\d+)([^\d]+)(\d+)$/);
      const plateText = document.createElement("p");
      if (match) {
        const span1 = document.createElement("span");
        span1.className = "plate-text";
        span1.innerHTML = match[1];
        const span2 = document.createElement("span");
        span2.innerHTML = match[2];
        const span3 = document.createElement("span");
        span3.className = "plate-text";
        span3.innerHTML = match[3];
        plateText.append(span1, span2, span3);
      } else {
        plateText.innerHTML = text;
      }

      colDiv.append(img, plateText);
      plateContainer.removeChild(plateContainer.lastChild);
      plateContainer.appendChild(colDiv);
    }
    function b64toBlob(b64) {
      const byteCharacters = atob(b64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: "image/png" });
    }
    async function uploadImage(selectedFile) {
      document.getElementById("file-upload").style.display = "none";
      document.getElementById("file-details").style.display = "block";
      plateContainer.parentElement.style.display = "none";
      car.parentElement.style.display = "none";
      document.getElementById("filename").innerHTML = selectedFile.name;
      let size = selectedFile.size;
      let displaySize;
      if (size >= 1024 * 1024) {
        displaySize = `${(size / (1024 * 1024)).toFixed(1)} MB`;
      } else {
        displaySize = `${Math.round(size / 1024)} KB`;
      }
      document.getElementById("filesize").innerHTML = displaySize;

      const detection_payload = new FormData();
      detection_payload.append(
        "model",
        "detector_" + document.getElementById("model-string").textContent
      );
      detection_payload.append("file", selectedFile);

      try {
        const xhr = new XMLHttpRequest();
        const getDetectionResponse = await new Promise((resolve) => {
          xhr.upload.addEventListener("progress", (event) => {
            if (event.lengthComputable) {
              console.log("upload progress:", event.loaded / event.total);
              uploadProgress.style.width = `${
                (event.loaded / event.total) * 100
              }%`;
              uploadProgress.innerHTML = `${Math.round(
                (event.loaded / event.total) * 100
              )}%`;
              if (event.loaded === event.total) {
                car.innerHTML = "";
                car.parentElement.style.display = "block";
                loading.className = "";
                car.appendChild(loading);
                car.scrollIntoView({ behavior: "smooth" });
              }
            }
          });
          xhr.addEventListener("loadend", () => {
            console.log("request complete");
            const responseJson = JSON.parse(xhr.responseText);
            resolve(responseJson);
          });
          xhr.open("POST", "/detect", true);
          xhr.send(detection_payload);
        });

        const detection_data = getDetectionResponse;
        console.log("result :", detection_data);

        // if (!detection_response.ok) {
        //   throw new Error(`HTTP error! status: ${detection_response.status}`);
        // }

        let should_send_request = parseInt(detection_data.count) > 0;
        const carBlob = b64toBlob(detection_data.image);
        const carUrl = URL.createObjectURL(carBlob);

        car.innerHTML = "";
        plateContainer.innerHTML = "";
        car.parentElement.style.display = "block";
        car.appendChild(document.createElement("img")).src = carUrl;
        plateContainer.parentElement.style.display = "block";
        if (!should_send_request)
          plateContainer.innerHTML = "No license plate found";
        while (should_send_request) {
          plateContainer.appendChild(loading);
          plateContainer.lastChild.className = "col md-6";
          const recognition_response = await fetch(
            `/recognize?rid=${detection_data.rid}&model=${selected_recognizer_model}`
          );

          const recognition_data = await recognition_response.json();
          const plateBlob = b64toBlob(recognition_data.image);
          const plateUrl = URL.createObjectURL(plateBlob);
          addPlate(plateUrl, recognition_data.text);
          should_send_request = recognition_data.more;
        }
      } catch (error) {
        console.error("Error: ", error);
      }
    }
  </script>
</html>

<!-- <div class="card md-4 col margin-right margin-bottom">
        <div class="card-body">
          <h4 class="card-title">Model Selection</h4>
          <h5 class="card-subtitle">Plate Detector Model</h5>
          <table class="table-hover model-selection">
            <thead>
              <tr>
                <th>name</th>
                <th>size</th>
                <th>epochs</th>
                <th>training results</th>
                <th>validation results</th>
              </tr>
            </thead>
            <tbody>
              <tr
                onclick="selectModel(this,'detector')"
                data-model="plate_detector_e1"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  small
                  <div popover-bottom="13M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>
                <td>1</td>
                <td>
                  <div
                    popover-bottom="box_loss: 2.7293 - class_loss: 81.0136 - loss: 83.7430"
                    style="margin: 0"
                  >
                    <label for="modal-1"> training </label>
                    <input class="modal-state" id="modal-1" type="checkbox" />
                    <div class="modal">
                      <label class="modal-bg" for="modal-1"></label>
                      <div class="modal-body">
                        <label class="btn-close" for="modal-1">X</label>
                        <h4 class="modal-title">Modal Title</h4>
                        <h5 class="modal-subtitle">Modal Subtitle</h5>
                        <p class="modal-text">
                          This is an example of modal which is implemented with
                          pure CSS! :D
                        </p>
                        <label for="modal-1">Nice!</label>
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <div
                    popover-bottom="MaP: 0.5142 - MaP@[IoU=50]: 0.8632 - MaP@[IoU=75]: 0.5824 - MaP@[area=small]: 0.3351 - MaP@[area=medium]: 0.6169 - MaP@[area=large]: 0.5014 - Recall@[max_detections=1]: 0.5314 - Recall@[max_detections=10]: 0.5958 - Recall@[max_detections=100]: 0.5958 - Recall@[area=small]: 0.4460 - Recall@[area=medium]: 0.6944 - Recall@[area=large]: 0.5991"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
              </tr>
              <tr
                onclick="selectModel(this,'detector')"
                data-model="plate_detector"
                style="background: #69a1d433"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  small
                  <div popover-bottom="13M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>
                <td>3</td>
              </tr>
              <tr
                onclick="selectModel(this,'detector')"
                data-model="plate_detector_e3_m"
                style="background: #69a1d433"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  medium
                  <div popover-bottom="26M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>
                <td>3</td>
                <td>
                  <div
                    popover-bottom="box_loss: 1.1675 - class_loss: 0.6682 - loss: 1.8357"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
                <td>
                  <div
                    popover-bottom="MaP: 0.5843 - MaP@[IoU=50]: 0.8867 - MaP@[IoU=75]: 0.6897 - MaP@[area=small]: 0.4411 - MaP@[area=medium]: 0.6713 - MaP@[area=large]: 0.5395 - Recall@[max_detections=1]: 0.5986 - Recall@[max_detections=10]: 0.6545 - Recall@[max_detections=100]: 0.6545 - Recall@[area=small]: 0.5295 - Recall@[area=medium]: 0.7433 - Recall@[area=large]: 0.6226"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <h5 class="card-subtitle" style="margin-top: 16px">
            Plate Recognizer Model
          </h5>
          <table class="table-hover model-selection">
            <thead>
              <tr>
                <th>name</th>
                <th>size</th>
                <th>epochs</th>
                <th>validation results</th>
              </tr>
            </thead>
            <tbody>
              <tr
                onclick="selectModel(this,'recognizer')"
                data-model="plate_recognizer"
                style="background: #69a1d433"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  small
                  <div popover-bottom="13M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>
                <td>3</td>
              </tr>
              <tr
                onclick="selectModel(this,'recognizer')"
                data-model="plate_recognizer_e5"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  small
                  <div popover-bottom="13M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>

                <td>5</td>
                <td>
                  <div
                    popover-bottom="box_loss: 0.8680 - class_loss: 0.0130 - loss: 0.8810"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
                <td>
                  <div
                    popover-bottom="MaP: 0.5672 - MaP@[IoU=50]: 0.7952 - MaP@[IoU=75]: 0.6857 - MaP@[area=small]: 0.0000e+00 - MaP@[area=medium]: 0.6867 - MaP@[area=large]: 0.5426 - Recall@[max_detections=1]: 0.5497 - Recall@[max_detections=10]: 0.6141 - Recall@[max_detections=100]: 0.6141 - Recall@[area=small]: 0.0000e+00 - Recall@[area=medium]: 0.7253 - Recall@[area=large]: 0.5924"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
              </tr>
              <tr
                onclick="selectModel(this,'recognizer')"
                data-model="plate_recognizer_e2_m"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  medium
                  <div popover-bottom="26M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>

                <td>2</td>
                <td>
                  <div
                    popover-bottom="box_loss: 0.9695 - class_loss: 0.0186 - loss: 0.9881"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
                <td>
                  <div
                    popover-bottom="MaP: 0.5056 - MaP@[IoU=50]: 0.7251 - MaP@[IoU=75]: 0.6018 - MaP@[area=small]: 0.0000e+00 - MaP@[area=medium]: 0.6259 - MaP@[area=large]: 0.4593 - Recall@[max_detections=1]: 0.4972 - Recall@[max_detections=10]: 0.5599 - Recall@[max_detections=100]: 0.5599 - Recall@[area=small]: 0.0000e+00 - Recall@[area=medium]: 0.6927 - Recall@[area=large]: 0.4952"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
              </tr>

              <tr
                onclick="selectModel(this,'recognizer')"
                data-model="plate_recognizer_e3_l"
              >
                <td>YOLO v8</td>
                <td class="has-info">
                  large
                  <div popover-bottom="41M parameters" style="margin: 0">
                    <img
                      class="no-border info"
                      src="/static/assets/icons/info.svg"
                    />
                  </div>
                </td>

                <td>3</td>
                <td>
                  <div
                    popover-bottom="box_loss: 0.9215 - class_loss: 0.0151 - loss: 0.9366"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
                <td>
                  <div
                    popover-bottom="MaP: 0.4944 - MaP@[IoU=50]: 0.7506 - MaP@[IoU=75]: 0.5873 - MaP@[area=small]: 0.0000e+00 - MaP@[area=medium]: 0.5958 - MaP@[area=large]: 0.4779 - Recall@[max_detections=1]: 0.4887 - Recall@[max_detections=10]: 0.5497 - Recall@[max_detections=100]: 0.5497 - Recall@[area=small]: 0.0000e+00 - Recall@[area=medium]: 0.6311 - Recall@[area=large]: 0.5491"
                    style="margin: 0"
                  >
                    show
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div> -->
