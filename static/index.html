<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>deepelak</title>
    <link rel="stylesheet" href="/static/assets/style/paper.css" />
    <link rel="stylesheet" href="/static/assets/style/style.css" />
    <link rel="icon" href="/static/assets/icons/favicon.svg" />
  </head>
  <body class="paper">
    <div class="row">
      <div class="card md-8 col margin-right margin-bottom">
        <div class="card-body">
          <h4 class="card-title">DeePelak</h4>
          <h5 class="card-subtitle">interactive ALPR playground</h5>
          <p class="card-text">
            Explore ALPR models in action — upload images, tweak settings, and
            compare automatic license plate recognition results instantly.
          </p>
          <a
            href="https://colab.research.google.com/drive/1AQWI11t2PuihdivXBwxGZpU8Wf_9wETD"
            target="_blank"
            >colab</a
          >
          <a target="_blank" href="https://github.com/HesamSoleymani/deepelak"
            >github</a
          >
        </div>
      </div>
    </div>
    <div class="row">
      <div class="card md-4 col margin-right margin-bottom">
        <div class="card-body">
          <h4 class="card-title">Model Selection</h4>
          <h5 class="card-subtitle">Plate Detector Model</h5>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label>current selected model</label>
              <div
                id="model-string"
                class="input-block padding-small"
                style="
                  background: #f5f5f5;
                  padding: 8px 12px;
                  border-radius: 4px;
                "
              >
                yolov8_s_none_0.001_e1
              </div>
            </div>
          </div>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label for="detector-model-name">Model Name</label>
              <select id="detector-model-name" class="input-block">
                <option value="yolov8" selected>YOLOv8</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-model-size">Model Size</label>
              <select id="detector-model-size" class="input-block">
                <option value="xs">XS</option>
                <option value="s">S</option>
                <option value="m">M</option>
                <option value="l">L</option>
                <option value="xl">XL</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-pretrained">Pretrained On</label>
              <select id="detector-pretrained" class="input-block">
                <option value="none" selected>None</option>
                <option value="coco">COCO</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-lr">Learning Rate</label>
              <select id="detector-lr" class="input-block">
                <option value="0.0001">0.0001</option>
                <option value="0.0005">0.0005</option>
                <option value="0.001" selected>0.001</option>
                <option value="0.005">0.005</option>
                <option value="0.01">0.01</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="detector-epochs">Epochs</label>
              <select id="detector-epochs" class="input-block">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
          <script>
            function updateModelString() {
              const name = document.getElementById("detector-model-name").value;
              const size = document.getElementById("detector-model-size").value;
              const pretrained = document.getElementById(
                "detector-pretrained"
              ).value;
              const lr = document.getElementById("detector-lr").value;
              let epochs = document.getElementById("detector-epochs").value;
              epochs = epochs.padStart(4, "0");
              const modelStr = `${name}_${size}_${pretrained}_${lr}_e${epochs}`;
              document.getElementById("model-string").textContent = modelStr;
              window.selected_detector_model = "detector_" + modelStr;
            }
            [
              "detector-model-name",
              "detector-model-size",
              "detector-pretrained",
              "detector-lr",
              "detector-epochs",
            ].forEach((id) => {
              document
                .getElementById(id)
                .addEventListener("change", updateModelString);
            });
            updateModelString();
          </script>
          <h5 class="card-subtitle" style="margin-top: 16px">
            Plate Recognizer Model
          </h5>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label for="recognizer-model-name">Model Name</label>
              <select id="recognizer-model-name" class="input-block">
                <option value="yolov8" selected>YOLOv8</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="recognizer-model-size">Model Size</label>
              <select id="recognizer-model-size" class="input-block">
                <option value="xs">XS</option>
                <option value="s">S</option>
                <option value="m">M</option>
                <option value="l">L</option>
                <option value="xl">XL</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="recognizer-pretrained">Pretrained On</label>
              <select id="recognizer-pretrained" class="input-block">
                <option value="none" selected>None</option>
                <option value="coco">COCO</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="recognizer-lr">Learning Rate</label>
              <select id="recognizer-lr" class="input-block">
                <option value="0.0001">0.0001</option>
                <option value="0.0005">0.0005</option>
                <option value="0.001" selected>0.001</option>
                <option value="0.005">0.005</option>
                <option value="0.01">0.01</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="recognizer-epochs">Epochs</label>
              <select id="recognizer-epochs" class="input-block">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label>current selected model</label>
              <div
                id="recognizer-model-string"
                class="input-block padding-small"
                style="
                  background: #f5f5f5;
                  padding: 8px 12px;
                  border-radius: 4px;
                "
              >
                yolov8_s_none_0.001_e1
              </div>
            </div>
          </div>
          <script>
            function updateRecognizerModelString() {
              const name = document.getElementById(
                "recognizer-model-name"
              ).value;
              const size = document.getElementById(
                "recognizer-model-size"
              ).value;
              const pretrained = document.getElementById(
                "recognizer-pretrained"
              ).value;
              const lr = document.getElementById("recognizer-lr").value;
              let epochs = document.getElementById("recognizer-epochs").value;
              epochs = epochs.padStart(4, "0");
              const modelStr = `${name}_${size}_${pretrained}_${lr}_e${epochs}`;
              document.getElementById("recognizer-model-string").textContent =
                modelStr;
              window.selected_recognizer_model = "recognizer_" + modelStr;
            }
            [
              "recognizer-model-name",
              "recognizer-model-size",
              "recognizer-pretrained",
              "recognizer-lr",
              "recognizer-epochs",
            ].forEach((id) => {
              document
                .getElementById(id)
                .addEventListener("change", updateRecognizerModelString);
            });
            updateRecognizerModelString();
          </script>
        </div>
      </div>
      <div class="card md-4 col">
        <div id="file-upload" class="card-body">
          <div class="row">
            <input id="file" type="file" hidden />
            <input
              id="buttonid"
              type="button"
              class="btn-block btn-secondary-outline"
              value="Upload Car Image"
              onclick="handleFileUpload()"
            />
          </div>
          <div class="separator">
            <h5 class="card-subtitle">Or choose from images below</h5>
          </div>
          <div class="row">
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car1.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car2.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car3.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car4.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car5.jpg"
              onclick="handleThumbnailClick(this)"
            />
            <img
              class="thumbnail"
              src="/static/assets/images/samples/car6.jpg"
              onclick="handleThumbnailClick(this)"
            />
          </div>
        </div>
        <div id="file-details" class="card-body" style="display: none">
          <div class="row flex-bottom" style="flex-wrap: nowrap">
            <img
              id="uploaded-file"
              class="thumbnail margin-right"
              src="/static/assets/images/samples/car1.jpg"
            />
            <div style="overflow: hidden">
              <p id="filename" class="cut-text"></p>
              <p id="filesize" style="margin-bottom: 0 !important"></p>
            </div>
          </div>
          <div class="progress margin-bottom">
            <div id="upload-progress" class="bar striped secondary w-40"></div>
          </div>
          <div
            id="restart"
            class="text-center margin-top"
            style="cursor: pointer"
          >
            <a>Upload another image</a>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div
        class="card md-4 col margin-right margin-bottom"
        style="display: none"
      >
        <div>
          <p style="margin: 0">step 1:</p>
          <h3 style="margin: 0">License Plate Detection</h3>
          <div class="model">
            <span>model:</span>
            <span class="badge secondary">YOLO V8</span>
            <!-- <div
              popover-bottom="epochs = 3 | learning rate = 0.001 | global clipnorm = 10"
            >
              <img class="no-border info" src="/static/assets/icons/info.svg" />
            </div> -->
          </div>
        </div>
        <div id="car"></div>
      </div>
      <div class="card md-4 col" style="display: none">
        <div>
          <p style="margin: 0">step 2:</p>
          <h3 style="margin: 0">License Plate Recognition</h3>
          <div class="model">
            <span>model:</span>
            <span class="badge secondary">YOLO V8</span>
            <!-- <div
              popover-bottom="epochs = 3 | learning rate = 0.001 | global clipnorm = 10"
            >
              <img class="no-border info" src="/static/assets/icons/info.svg" />
            </div> -->
          </div>
        </div>
        <div class="row flex-spaces" id="plate-container"></div>
      </div>
    </div>
    <div class="row">
      <div class="card md-8 col margin-bottom">
        <div class="card-body">
          <h4 class="card-title">Results</h4>
          <div class="col padding-small">
            <label for="result-type">Result Type</label>
            <select id="result-type" class="input-block">
              <option value="detector">Detector</option>
              <option value="recognizer">Recognizer</option>
            </select>
          </div>
          <p class="card-text" style="margin-top: 20px !important">
            Compare all models
          </p>
          <canvas id="mapComparisonChart" width="800" height="400"></canvas>
          <p class="card-text" style="margin-top: 40px !important">
            Visualize model metrics over epochs, model size, or other
            parameters.
          </p>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label for="phase-type">Phase</label>
              <select id="phase-type" class="input-block">
                <option value="training">Training</option>
                <option value="validation">Validation</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="x-axis">X-axis Parameter</label>
              <select id="x-axis" class="input-block">
                <option value="epoch">Epoch</option>
                <option value="lr">Learning Rate</option>
                <option value="size">Model Size</option>
                <option value="pretrained">Pretrained</option>
              </select>
            </div>
            <div class="col padding-small">
              <label for="y-axis">Y-axis Metric</label>
              <select id="y-axis" class="input-block"></select>
            </div>
          </div>
          <div class="row margin-bottom">
            <div class="col padding-small">
              <label for="const-epoch">Epoch</label>
              <select id="const-epoch" class="input-block"></select>
            </div>
            <div class="col padding-small">
              <label for="const-lr">Learning Rate</label>
              <select id="const-lr" class="input-block"></select>
            </div>
            <div class="col padding-small">
              <label for="const-size">Model Size</label>
              <select id="const-size" class="input-block"></select>
            </div>
            <div class="col padding-small">
              <label for="const-pretrained">Pretrained</label>
              <select id="const-pretrained" class="input-block"></select>
            </div>
            <div class="col padding-small">
              <button class="btn-block btn-primary" onclick="plotResults()">
                Show Graph
              </button>
            </div>
          </div>
          <canvas id="results-chart" style="height: 400px"></canvas>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      function shortenLabel(modelName) {
        const parts = modelName.split("_");

        let type = parts[0].startsWith("recognizer") ? "rec" : "det"; // کوتاه کردن
        let size =
          parts.find((p) => ["xs", "s", "m", "l", "xl"].includes(p)) || "";
        let epochPart = parts.find((p) => p.startsWith("e"));
        let epoch = epochPart
          ? "e" + parseInt(epochPart.replace("e", ""), 10)
          : "";

        return [type, size, epoch].filter(Boolean).join("_");
      }

      let allResults = [];
      let allFiles = [];

      // Y-axis metric options for each phase
      const yAxisOptions = {
        training: [
          { value: "loss", label: "Loss" },
          { value: "box_loss", label: "Box Loss" },
          { value: "class_loss", label: "Class Loss" },
        ],
        validation: [
          { value: "MaP", label: "MaP" },
          { value: "MaP@[IoU=50]", label: "MaP@[IoU=50]" },
          { value: "MaP@[IoU=75]", label: "MaP@[IoU=75]" },
          { value: "MaP@[area=small]", label: "MaP@[area=small]" },
          { value: "MaP@[area=medium]", label: "MaP@[area=medium]" },
          { value: "MaP@[area=large]", label: "MaP@[area=large]" },
          {
            value: "Recall@[max_detections=1]",
            label: "Recall@[max_detections=1]",
          },
          {
            value: "Recall@[max_detections=10]",
            label: "Recall@[max_detections=10]",
          },
          {
            value: "Recall@[max_detections=100]",
            label: "Recall@[max_detections=100]",
          },
          { value: "Recall@[area=small]", label: "Recall@[area=small]" },
          { value: "Recall@[area=medium]", label: "Recall@[area=medium]" },
          { value: "Recall@[area=large]", label: "Recall@[area=large]" },
        ],
      };

      function updateYAxisOptions() {
        const phase = document.getElementById("phase-type").value;
        const yAxis = document.getElementById("y-axis");
        yAxis.innerHTML = "";
        yAxisOptions[phase].forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          yAxis.appendChild(option);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateYAxisOptions();
        document
          .getElementById("phase-type")
          .addEventListener("change", updateYAxisOptions);
      });

      async function loadAllResults() {
        const res = await fetch("/static/results/files.json");
        allFiles = await res.json();
        await reloadResults();
      }
      let mapComparisonChartInstance = null;
      async function reloadResults() {
        allResults = [];
        const resultType = document.getElementById("result-type").value;
        const prefix = resultType === "detector" ? "detector_" : "recognizer_";
        const filteredFiles = allFiles.filter((f) => f.startsWith(prefix));
        const values = {
          epoch: new Set(),
          lr: new Set(),
          size: new Set(),
          pretrained: new Set(),
        };
        for (const file of filteredFiles) {
          const r = await fetch(`/static/results/${file}`);
          const json = await r.json();
          allResults.push(json);

          const parts = json.Name.split("_");
          const size = parts[2];
          const pretrained = parts[3];
          const lr = parts[4];
          let epoch = 0;
          if (parts[5] && parts[5].startsWith("e")) {
            epoch = parseInt(parts[5].slice(1), 10);
          }
          values.size.add(size);
          values.pretrained.add(pretrained);
          values.lr.add(lr);
          if (!isNaN(epoch) && epoch > 0) values.epoch.add(epoch);
        }

        // map comparison chart
        const data = allResults.map((r) => ({
          model: r.Name,
          map: parseFloat(r["MaP"]),
        }));

        data.sort((a, b) => a.map - b.map);
        if (mapComparisonChartInstance) {
          mapComparisonChartInstance.destroy();
        }
        const ctx = document
          .getElementById("mapComparisonChart")
          .getContext("2d");
        mapComparisonChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.map((d) => shortenLabel(d.model)),
            datasets: [
              {
                label: "MaP",
                data: data.map((d) => d.map),
                backgroundColor: "rgba(54, 162, 235, 0.6)",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                ticks: {
                  maxRotation: 90,
                  minRotation: 45,
                },
              },
              y: {
                // beginAtZero: true,
              },
            },
          },
        });

        // Populate dropdowns
        const toArray = (set) =>
          Array.from(set).sort((a, b) => {
            if (!isNaN(a) && !isNaN(b)) return a - b;
            return String(a).localeCompare(String(b));
          });

        // Populate each dropdown with the correct values
        const epochSel = document.getElementById("const-epoch");
        epochSel.innerHTML = "";
        toArray(values.epoch).forEach((v) => epochSel.add(new Option(v, v)));

        const lrSel = document.getElementById("const-lr");
        lrSel.innerHTML = "";
        toArray(values.lr).forEach((v) => lrSel.add(new Option(v, v)));

        const sizeSel = document.getElementById("const-size");
        sizeSel.innerHTML = "";
        toArray(values.size).forEach((v) => sizeSel.add(new Option(v, v)));

        const preSel = document.getElementById("const-pretrained");
        preSel.innerHTML = "";
        toArray(values.pretrained).forEach((v) => preSel.add(new Option(v, v)));

        // Update constant dropdowns to disable the one matching x-axis
        updateConstantDropdowns();
      }

      function updateConstantDropdowns() {
        const xParam = document.getElementById("x-axis").value;
        const dropdowns = {
          epoch: document.getElementById("const-epoch"),
          lr: document.getElementById("const-lr"),
          size: document.getElementById("const-size"),
          pretrained: document.getElementById("const-pretrained"),
        };
        for (const key in dropdowns) {
          if (key === xParam) {
            dropdowns[key].disabled = true;
            dropdowns[key].classList.add("disabled");
          } else {
            dropdowns[key].disabled = false;
            dropdowns[key].classList.remove("disabled");
          }
        }
      }

      document
        .getElementById("x-axis")
        .addEventListener("change", updateConstantDropdowns);

      // Call this once on page load
      loadAllResults();

      document
        .getElementById("result-type")
        .addEventListener("change", reloadResults);

      async function plotResults() {
        const xParam = document.getElementById("x-axis").value;
        const yMetric = document.getElementById("y-axis").value;
        // Get constant values for all params except xParam
        const constParams = {
          epoch: document.getElementById("const-epoch").value,
          lr: document.getElementById("const-lr").value,
          size: document.getElementById("const-size").value,
          pretrained: document.getElementById("const-pretrained").value,
        };

        const dataPoints = [];

        for (const json of allResults) {
          const parts = json.Name.split("_");
          const meta = {
            size: parts[2],
            pretrained: parts[3],
            lr: parts[4],
            epoch: parseInt(parts[5].replace("e", "")),
          };

          let match = true;
          for (const key in constParams) {
            if (key === xParam) continue;
            if (String(meta[key]) !== String(constParams[key])) {
              match = false;
              break;
            }
          }

          if (match && json[yMetric] !== undefined) {
            dataPoints.push({ x: meta[xParam], y: json[yMetric] });
          }
        }

        // Remove duplicate x values (keep first occurrence)
        const uniqueData = [];
        const seen = new Set();
        for (const d of dataPoints) {
          if (!seen.has(d.x)) {
            uniqueData.push(d);
            seen.add(d.x);
          }
        }

        uniqueData.sort((a, b) => {
          if (typeof a.x === "number" && typeof b.x === "number")
            return a.x - b.x;
          return String(a.x).localeCompare(String(b.x));
        });

        const ctx = document.getElementById("results-chart").getContext("2d");
        if (window.resultsChart) window.resultsChart.destroy();

        window.resultsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: uniqueData.map((d) => d.x),
            datasets: [
              {
                label: `${yMetric} vs ${xParam}`,
                data: uniqueData.map((d) => d.y),
                fill: false,
                borderColor: "rgb(75, 192, 192)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: xParam } },
              y: {
                title: { display: true, text: yMetric },
                min: yMetric.includes("loss") ? undefined : 0,
                max: yMetric.includes("loss") ? undefined : 1,
              },
            },
          },
        });
      }
    </script>
  </body>
  <script>
    let selected_detector_model = "plate_detector";
    let selected_recognizer_model = "plate_recognizer";
    const fileInput = document.getElementById("file");
    const plateContainer = document.getElementById("plate-container");
    const uploadProgress = document.getElementById("upload-progress");
    const car = document.getElementById("car");
    const loading = document.createElement("div");
    loading.appendChild(document.createElement("img"));
    loading.appendChild(document.createElement("p"));
    loading.childNodes[0].className = "loading no-border";
    loading.childNodes[0].src = "/static/assets/icons/processing.svg";
    loading.childNodes[1].innerHTML = "processing...";
    loading.childNodes[1].className = "text-center";
    document
      .getElementById("restart")
      .addEventListener("click", function (event) {
        document.getElementById("file-upload").style.display = "block";
        document.getElementById("file-details").style.display = "none";
      });
    fileInput.addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file.size > 10 * 1024 * 1024) {
        alert("Filesize is too large! Max filesize is 10MB.");
        return;
      }
      document.getElementById("uploaded-file").src = URL.createObjectURL(file);
      if (file) {
        uploadImage(file);
      }
      fileInput.value = "";
    });
    function handleFileUpload() {
      fileInput.click();
    }
    function handleThumbnailClick(img) {
      document.getElementById("uploaded-file").src = img.src;
      fetch(img.src)
        .then((res) => res.blob())
        .then((blob) => {
          const file = new File([blob], img.src.split("/").pop(), {
            type: blob.type,
          });
          uploadImage(file);
        });
    }
    function selectModel(div, type) {
      div.parentElement.childNodes.forEach((element) => {
        if (element.style?.background) {
          element.style.background = "transparent";
        }
      });
      div.style.background = "#69a1d433";
      if (type == "detector") selected_detector_model = div.dataset.model;
      else selected_recognizer_model = div.dataset.model;
    }
    function addPlate(imgUrl, text) {
      const colDiv = document.createElement("div");
      colDiv.className = "col md-6";
      const img = document.createElement("img");
      img.src = imgUrl;

      const match = text.match(/^(\d+)([^\d]+)(\d+)$/);
      const plateText = document.createElement("p");
      if (match) {
        const span1 = document.createElement("span");
        span1.className = "plate-text";
        span1.innerHTML = match[1];
        const span2 = document.createElement("span");
        span2.innerHTML = match[2];
        const span3 = document.createElement("span");
        span3.className = "plate-text";
        span3.innerHTML = match[3];
        plateText.append(span1, span2, span3);
      } else {
        plateText.innerHTML = text;
      }

      colDiv.append(img, plateText);
      plateContainer.removeChild(plateContainer.lastChild);
      plateContainer.appendChild(colDiv);
    }
    function b64toBlob(b64) {
      const byteCharacters = atob(b64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: "image/png" });
    }
    async function uploadImage(selectedFile) {
      document.getElementById("file-upload").style.display = "none";
      document.getElementById("file-details").style.display = "block";
      plateContainer.parentElement.style.display = "none";
      car.parentElement.style.display = "none";
      document.getElementById("filename").innerHTML = selectedFile.name;
      let size = selectedFile.size;
      let displaySize;
      if (size >= 1024 * 1024) {
        displaySize = `${(size / (1024 * 1024)).toFixed(1)} MB`;
      } else {
        displaySize = `${Math.round(size / 1024)} KB`;
      }
      document.getElementById("filesize").innerHTML = displaySize;

      const detection_payload = new FormData();
      detection_payload.append(
        "model",
        window.selected_detector_model.replace("_none", "")
      );
      detection_payload.append("file", selectedFile);

      try {
        const xhr = new XMLHttpRequest();
        const getDetectionResponse = await new Promise((resolve) => {
          xhr.upload.addEventListener("progress", (event) => {
            if (event.lengthComputable) {
              uploadProgress.style.width = `${
                (event.loaded / event.total) * 100
              }%`;
              uploadProgress.innerHTML = `${Math.round(
                (event.loaded / event.total) * 100
              )}%`;
              if (event.loaded === event.total) {
                car.innerHTML = "";
                car.parentElement.style.display = "block";
                loading.className = "";
                car.appendChild(loading);
                car.scrollIntoView({ behavior: "smooth" });
              }
            }
          });
          xhr.addEventListener("loadend", () => {
            let responseJson;
            try {
              responseJson = JSON.parse(xhr.responseText);
            } catch (e) {
              responseJson = { error: "Invalid server response" };
            }
            resolve(responseJson);
          });
          xhr.open("POST", "/detect", true);
          xhr.send(detection_payload);
        });

        const detection_data = getDetectionResponse;
        car.innerHTML = "";
        plateContainer.innerHTML = "";
        if (detection_data.error) {
          car.parentElement.style.display = "block";
          car.innerHTML = `<div class='error-message'>${detection_data.error}</div>`;
          plateContainer.parentElement.style.display = "none";
          return;
        }
        let should_send_request = parseInt(detection_data.count) > 0;
        const carBlob = b64toBlob(detection_data.image);
        const carUrl = URL.createObjectURL(carBlob);
        car.parentElement.style.display = "block";
        car.appendChild(document.createElement("img")).src = carUrl;
        plateContainer.parentElement.style.display = "block";
        if (!should_send_request) {
          plateContainer.innerHTML = "No license plate found";
        }
        while (should_send_request) {
          plateContainer.appendChild(loading);
          plateContainer.lastChild.className = "col md-6";
          const recognition_response = await fetch(
            `/recognize?rid=${
              detection_data.rid
            }&model=${window.selected_recognizer_model.replace("_none", "")}`
          );
          const recognition_data = await recognition_response.json();
          if (recognition_data.error) {
            plateContainer.innerHTML = `<div class='error-message'>${recognition_data.error}</div>`;
            break;
          }
          const plateBlob = b64toBlob(recognition_data.image);
          const plateUrl = URL.createObjectURL(plateBlob);
          addPlate(plateUrl, recognition_data.text);
          should_send_request = recognition_data.more;
        }
      } catch (error) {
        car.innerHTML = `<div class='error-message'>${error}</div>`;
        car.parentElement.style.display = "block";
        plateContainer.parentElement.style.display = "none";
        console.error("Error: ", error);
      }
    }
  </script>
</html>
